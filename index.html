<!DOCTYPE html>
<meta charset="utf-8">
<svg width="640" height="400"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>


//var data = [
//  {country: "China", apples: 3840, bananas: 1920, cherries: -1960},
//  {country: "USA", apples: 1600, bananas: 1440, cherries: -960},
//  {country: "India", apples:  640, bananas:  960, cherries: -640},
//  {country: "Brazil", apples:  320, bananas:  480, cherries: -640}
//];

var data = [
  {country: "China", apples: 3840, bananas: 1920, cherries: 700, index: 0},
  {country: "USA", apples: 1600, bananas: 1440, cherries: 960, index: 3},
  {country: "India", apples:  640, bananas:  960, cherries: 640, index: 2},
  {country: "Brazil", apples:  320, bananas:  480, cherries: 640, index: 1}
];

var countryNames = data.map( function(d) {
      return d.country;
});

var fruitNames = d3.keys(data[0]).filter(function(key) {
                                    if (key !== "country" && key !== "index")
                                      return true;
                                    else
                                      return false;
                 });

var tooltip = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .text("a simple tooltip");

data.forEach(function(d) {
    d.fruitsConsumed = fruitNames.map(function(name) {
        return {
            "fruitName": name,
            "consumedCount": d[name]
        };
    });

    d.totalFruit = d3.sum( d.fruitsConsumed, function(d) {
        return d.consumedCount;
    });
});

data.sort(function(x, y){
  return d3.ascending(x.index, y.index);
});

//
// Data Transform
var series = d3.stack()
    .keys(["apples", "bananas", "cherries"])
    .offset(d3.stackOffsetDiverging)
    (data);


// Scales
var svg = d3.select("svg"),
    margin = {top: 20, right: 10, bottom: 30, left: 60},
    width = +svg.attr("width"),
    height = +svg.attr("height");

var y = d3.scaleBand()
    .domain(countryNames)
    .rangeRound([margin.top, height - margin.bottom])
    .padding(0.1);

var x = d3.scaleLinear()
    .domain([d3.min(series, stackMin), d3.max(series, stackMax)])
    .rangeRound([margin.left, width- margin.right]);

var z = d3.scaleOrdinal(d3.schemeCategory10);
//var z = d3.scaleOrdinal()
//          .domain(fruitNames)
//          .range(["#d62728", "#2ca02c", "#9467bd"]);


//
// DBG
var layers = fruitNames.map(function(fruitName) {
    return data.map(function(d) {
        return {"y": y(d.country), "x": d[fruitName], "fruitName":fruitName};
    });
});

//
// Rendering
svg.append("g")
  .selectAll("g")
  .data(series)
  .enter().append("g")
    .attr("fill", function(d) { return z(d.key); })
  .selectAll("rect")
  .data(function(d) { return d; })
  .enter().append("rect")
    .attr("height", y.bandwidth)
    .attr("y", function(d) { return y(d.data.country); })
    .attr("x", function(d) { return x(d[0]); })
    .attr("width", function(d) { return x(d[1]) - x(d[0]); })
    .on("mouseover", function(d){tooltip.text(d[1]-d[0]); return tooltip.style("visibility", "visible");})
    .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
    .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

svg.append("g")
    .attr("transform", "translate(0," + margin.top + ")")
    .call(d3.axisTop(x));

svg.append("g")
    .attr("transform", "translate(" + margin.left + ",0)")
    .call(d3.axisLeft(y));

function stackMin(serie) {
  return d3.min(serie, function(d) { return d[0]; });
}

function stackMax(serie) {
  return d3.max(serie, function(d) { return d[1]; });
}

//
// Render Legend
var legend = svg.selectAll(".legend")
    .data(series.slice(0))
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(-20," + i * 20 + ")"; })
      .style("font", "10px sans-serif");

  d3.select('svg').attr("width", width + margin.right + margin.left);

  legend.append("rect")
      .attr("x", width + 18)
      .attr("width", 18)
      .attr("height", 18)
      .attr("fill", function(d, i){  console.log(JSON.stringify(d.key)); return z(d.key)});

  legend.append("text")
      .attr("x", width + 44)
      .attr("y", 9)
      .attr("dy", ".35em")
      .attr("text-anchor", "start")
      .text(function(d, i) {  return d.key; });

</script>
